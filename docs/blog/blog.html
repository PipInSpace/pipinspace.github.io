<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog - VioletSpace</title>
    <!--Embed meta data-->
    <meta content="Blog - VioletSpace" property="og:title" />
    <meta content="Hi, this is my blog! Sometimes I post here." property="og:description" />
    <meta content="./" property="og:url" />
    <meta content="https://violetspace.github.io/img/CardBlog.jpg" property="og:image" />
    <meta content="#8822ee" data-react-helmet="true" name="theme-color" />
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Blog - VioletSpace">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="https://violetspace.github.io/img/CardBlog.jpg">
    <link rel="stylesheet" type="text/css" href="../styles/styles.css">
    <link rel="shortcut icon" type="image/x-icon" href="../img/icon.png">
</head>

<body>
    <div class="link-banner">
    <div class="title-links">
        <a href="../index.html">Home</a>
        <a href="blog.html">Blog</a>
        <a href="rss.xml">RSS</a>
    </div>
    <div class="social_icons">
        <a href="https://github.com/VioletSpace"       title="My GitHub profile">   My GitHub profile   <svg viewBox="0 0 496 512">
    <path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z" />
</svg>
 </a>
        <a href="https://mastodon.social/@pipinspace" title="Me on the Fediverse"> Me on the Fediverse <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 812.9 612.9" style="transform: scale(160%);">
    <g transform="translate(6.6789703,-32.495842)">
        <path id="path9722" d="M257.1,266.8c-4.9,9.4-12.6,17.1-22.1,22l121.3,121.8l29.2-14.8L257.1,266.8z M417.1,427.4l-29.2,14.8 l61.5,61.7c4.9-9.4,12.6-17.1,22.1-22L417.1,427.4z" />
        <path id="path9729" d="M557.5,315l-68.7,34.8l5.1,32.4l77.7-39.4C564.1,335.2,559.2,325.5,557.5,315z M448.9,370l-162.4,82.3 c7.5,7.6,12.4,17.3,14.1,27.8L454,402.4L448.9,370z" />
        <path id="path9713" d="M396.7,167.3l-78.4,153l23.1,23.2l83-162C414,179.7,404.3,174.7,396.7,167.3z M298,360l-39.7,77.5 c10.5,1.8,20.2,6.7,27.7,14.2l35.1-68.5L298,360z" />
        <path id="path1015" d="M234.3,289.1c-8,4-16.9,5.9-25.8,5.4c-1.7-0.1-3.3-0.3-5-0.5l23.2,148.2c8-4,16.9-5.9,25.8-5.4 c1.7,0.1,3.3,0.3,5,0.5L234.3,289.1z" />
        <path id="path1674" d="M300.8,480.8c0.5,3.4,0.7,6.9,0.5,10.4c-0.4,7.1-2.3,14-5.5,20.4l148.2,23.8c-0.5-3.4-0.7-6.9-0.5-10.4 c0.4-7.1,2.3-14,5.5-20.4L300.8,480.8z" />
        <path id="path1676" d="M572.1,343.3l-68.4,133.6c10.5,1.8,20.2,6.7,27.7,14.2l68.4-133.6C589.4,355.8,579.7,350.8,572.1,343.3z" />
        <path id="path1678" d="M478.8,154.4c-4.9,9.4-12.6,17.1-22.1,22l105.9,106.4c4.9-9.4,12.6-17.1,22.1-22L478.8,154.4z" />
        <path id="path1680" d="M382.1,138.9l-133.9,67.9c7.5,7.6,12.4,17.3,14.1,27.8l133.9-67.9C388.7,159.1,383.8,149.4,382.1,138.9z" />
        <path id="path9758" d="M456.5,176.6c-8.1,4.1-17.1,6.1-26.2,5.6c-1.5-0.1-3-0.3-4.5-0.5l11.9,76l32.4,5.2L456.5,176.6z M444.5,301.8l28.1,179.6c7.9-3.9,16.7-5.7,25.4-5.2c1.8,0.1,3.6,0.3,5.4,0.6L476.8,307L444.5,301.8z" />
        <path id="path9760" d="M262.4,235.2c0.6,3.5,0.7,7,0.6,10.6c-0.4,7-2.2,13.9-5.4,20.2l76,12.2l14.9-29.2L262.4,235.2z M392.7,256.1 l-14.9,29.2l179.6,28.9c-0.5-3.4-0.7-6.9-0.5-10.3c0.4-7.1,2.3-14.1,5.5-20.5L392.7,256.1z" />
    </g>
    <g transform="translate(6.6789703,-32.495842)">
        <circle cx="433" cy="130.6" r="47" />
        <circle cx="608.4" cy="306.6" r="47" />
        <circle cx="495.1" cy="527.8" r="47" />
        <circle cx="249.7" cy="488.4" r="47" />
        <circle cx="211.3" cy="242.9" r="47" />
    </g>
</svg>
   </a>
        <a href="https://www.youtube.com/@pipinspace" title="My YouTube channel">  My YouTube channel  <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="100" height="100" viewBox="0 0 64 64" style="transform: scale(130%);">
    <path d="M53.527,17.427C55.714,19.677,56,23.252,56,32s-0.286,12.323-2.473,14.573C51.34,48.822,49.062,49,32,49	s-19.34-0.178-21.527-2.427C8.286,44.323,8,40.748,8,32s0.286-12.323,2.473-14.573S14.938,15,32,15S51.34,15.178,53.527,17.427z M27.95,39.417l12.146-7.038L27.95,25.451V39.417z"/>
</svg>
</a>
    </div>
</div>

    <div class="main_body">

        <h1>My Blog</h1>
        <p>
            Thank you for finding my Blog! On occasion, I might post something here about my projects, but I am much
            more
            active on <a href="https://mastodon.social/@pipinspace">Mastodon</a>. You can follow me there!
        </p>
        
        <h1>Current: <a href="atomic-float-addition-in-opencl.html">Atomic Float Addition in OpenCL</a></h1>
        <details style="margin-bottom: 20px;">
            <summary class="text-padding" style="cursor: pointer;">Click to view</summary>
            <p>The following code snippet is a cross-platform implementation of atomic float addition in OpenCL.
The implementation uses hardware-supported functions whereever possible and implements a fallback algorithm that is faster than most commonly used approaches.
I am sharing it here for other developers to use as a single function to handle atomic addition on all platforms uniformly.</p>
<link href="../styles/prism.css" rel="stylesheet" />
<script src="../files/prism.js"></script> <!--syntax highlighting-->
<pre class="lang-opencl"><code>inline void atomic_add_f(volatile __global float* addr, const float val) {
	#if defined(cl_nv_pragma_unroll) // use hardware-supported atomic addition on Nvidia GPUs with inline PTX assembly
		float ret; asm volatile("atom.global.add.f32 %0,[%1],%2;":"=f"(ret):"l"(addr),"f"(val):"memory");
	#elif defined(__opencl_c_ext_fp32_global_atomic_add) // use hardware-supported atomic addition on some Intel GPUs
		atomic_fetch_add_explicit((volatile global atomic_float*)addr, val, memory_order_relaxed);
	#elif __has_builtin(__builtin_amdgcn_global_atomic_fadd_f32) // use hardware-supported atomic addition on some AMD GPUs
		__builtin_amdgcn_global_atomic_fadd_f32(addr, val);
	#else // fallback emulation: https://forums.developer.nvidia.com/t/atomicadd-float-float-atomicmul-float-float/14639/5
		float old = val; while((old=atomic_xchg(addr, atomic_xchg(addr, 0.0f)+old))!=0.0f);
	#endif
}</code></pre>
<p>But why does this need to exist?
Atomic addition of integers is a core part of the OpenCL specification and is included in virtually all implementations of the spec.
Atomic addition of floating point numbers however is not officially part of the specification, and only a handful of atomic operations defined in the core spec accept floats at all (one of them being <code>atomic_xchg()</code>, used in the above implementation).
Because atomic float addition is a very useful tool and many algorithms depend on it, numerous vendors have implemented their own hardware-supported versions, sometimes with accompanying OpenCL extensions.
These are not standardized however and code using a specific extension will never be universally cross-platform. The above snippet defines a singular inline function that uses macros to expand only the supported implementation on the platform the code is compiled on.
If no compatible implementation is detected, the function expands into a functionally identical (but slower than native) implementation that is up to an order of magnitude(!!!) faster than common workarounds<sup><a id="1t" href="#1b">[1]</a></sup>.
I hope this code saves some headaches when working with atomic float addition! If you have any improvements for or thoughts on the code above feel free to reach out to me, preferably over the <a href="https://mastodon.social/@pipinspace">Fediverse</a>. I want to thank <a href="https://github.com/ProjectPhysX">ProjectPhysX</a> for compiling the implementations and especially for providing the PTX assembly for NVidia GPUs!</p>
<p><a id="1b" href="#1t">[1]</a>: Yes, really! Many implementations loose an immense amount of speed when conflicts between threads occur. One of the more common implementations uses only one <code>atomic_cmpxchg()</code> call in a while loop that checks for successful addition. This can quickly lead to race conditions where threads have to &quot;retry&quot; the addition every time another thread writes a new value to memory in between, possibly for hundreds of times. This completely degrades performance and in my tests is about 8000 times slower than the  fallback algorithm in the snippet above.</p>

<div class="blog_footer">16.09.2024 - 19:42</div>
        </details>

        <h1>All Posts</h1>
        <table class="blog_post_list">
<tr><td><a href="atomic-float-addition-in-opencl.html">Atomic Float Addition in OpenCL</a></td><td> 16.09.2024 - 19:42</td></tr>
<tr><td><a href="hiding-data.html">Hiding Data</a></td><td> 09.05.2024 - 13:32</td></tr>
<tr><td><a href="ionsolver-update.html">IonSolver Update</a></td><td> 04.04.2024 - 18:40</td></tr>
<tr><td><a href="rss-support.html">RSS support</a></td><td> 03.02.2024 - 12:36</td></tr>
<tr><td><a href="pagebuild-progress.html">Pagebuild progress</a></td><td> 03.02.2024 - 10:58</td></tr>
<tr><td><a href="hello-world.html">Hello World</a></td><td> 01.02.2024 - 18:43</td></tr>
<tr><td><a href="nothing.html">Nothing</a></td><td> 01.02.2024 - 18:39</td></tr>
</table>

        
        <div class="impressum">
    <div class="impressum_column impressum_left">
        <span>Navigation</span><br>
        <a class="a_impressum" href="../index.html">Home</a><br>
        <a class="a_impressum" href="../privacy.html">Privacy Notice</a><br>
        <a class="a_impressum" href="https://violetspace.github.io">Home again</a><br>
    </div>
    <div class="impressum_column impressum_center">
        <span>Copyright © 2022-2025</span><br>
        by VioletSpace.<br> All Rights Reserved.<br>
        <a href="https://violetspace.github.io"><img class="clickableImg no-select" draggable="false" src="../img/pfp.png"
                alt="profile pic" style="border-radius: 400px;">
        </a><br>
    </div>
    <div class="impressum_column impressum_right">
        <span>Impressum</span><br>
    </div>
</div>


    </div>

</body>

</html>
